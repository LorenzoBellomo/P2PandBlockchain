\documentclass[11pt, a4paper]{report}

\usepackage{nameref}
%\usepackage{graphicx} in case remember graphics path below
\usepackage{lmodern}
\usepackage[a4paper,top=3cm,bottom=4cm,left=3.5cm,right=3.5cm]{geometry}
\usepackage[font=footnotesize,labelfont={sf,bf}]{caption}
\usepackage{hyperref}
\usepackage{mathtools}
%\usepackage{float}


%\graphicspath{ {./latexImages/} }
\DeclarePairedDelimiter{\ceil}{\lceil}{\rceil}
% Title Page
\title{
	FinalTerm Peer2Peer Systems and blockchains \\
	\large Smart Auctions}
\author{Lorenzo Bellomo, 531423}
\date{}


\begin{document}
	\maketitle
	
\section*{Attached Files Structure}

	Attached with the project comes the auction files. The chosen auction is the Dutch one. \\
	The final term code consists of three files:
	\begin{itemize}
		\item \emph{dutchAuction.sol}: This file contains the Dutch auction logic. More details are explained in section \nameref{sec:dutchAuction}.
		\item \emph{decreaseLogic.sol}: This file, to be associated with \emph{dutchAuction.sol}, contains the \emph{DecreaseLogic} interface contracts, and the 3 implemented logics: \emph{Linear}, \emph{Exponential} and \emph{Logarithmic}.
		\item \emph{vickreyAuction.sol}: This file contains the logic of the Vickrey Auction. Further details are explained in section \nameref{sec:vickreyAuction}.
	\end{itemize}

\section*{Notes Common to Both Auctions}
\label{sec:common}
	\paragraph*{Handling of Time}
	Time was handled in the same way between the two auctions. All the durations (except for the one of grace time) are expressed in \emph{number of blocks} and are passed as parameter to the constructor of the auction. Grace time, instead, is constant and "hard coded" in the contract. To respect the specifications of the assignment this value should be around 20/23 in order to respect the request of a time close to 5 minutes for the grace time. This is computed assuming an average mining time of 13/15 seconds per block on the Ethereum blockchain (according to the values in \url{https://etherscan.io/chart/blocktime}). However, in the actual implementation, the constant value for graceTime is set to 2 in order to ease the burden of testing. \\
	The time passage is implemented in a \emph{lazy} way. What this means is that every time a major function, like \emph{bid()}, is called, the contract checks the current block number, and by confronting it to the first one (the block number when the auction was generated), and by checking the various durations specified, it computes the current phase. So no central entity is required to synchronize the auction (no auctioneer is required to dictate the passing of time). \\
	The main pros of this approach (lazy way), with respect to the one with the auctioneer that dictates the passage of time are:
	\begin{itemize}
		\item \emph{Completely decentralized}: No central entity (auctioneer) is required to make the time pass.
		\item \emph{Guaranteed time correctness (on average)}: The auctioneer model requires the this entity to make the time flow. This means that he might be late while calling the phase switch (but not early supposing that the contract checks the correctness of the auctioneer calls). This is not the case of the lazy implementation, where the checks are made for each call by the contract.\\ The time is guaranteed to be respected on average, with possible fluctuations given by the variability in the mining process. This could have been avoided by using the timestamp of the block of the function call transaction, but this hypothesis was discarded in order to stick to the project requirements and implement time with respect to number of blocks.
	\end{itemize}
	Instead the main cons of this choice are:
	\begin{itemize}
		\item \emph{Events variability}: Both of the auction implementations emit events related to the passage of time. Those events are fired whenever a phase switch is recognized. Since the phase switch process is lazy, the events may fire late with respect to the actual time in which the phase switched. This issue is inevitable in this kind of implementation, and it can be eased by providing a special method that checks the current phase of the auction and updates the state of the contract if enough time has passed. This method is \emph{checkIfAuctionEnded()} for the Dutch Auction and \emph{updateCurrentPhase()} for the Vickrey one.
		\item \emph{Events cost}: The cost of those events emissions (which is very high with respect to normal EVM instructions) are in the general case at the expenses of the users (the bidders), which fire those events by executing the main methods of the contracts. The same "solution" of the first point is adopted, but this problem is evident, particularly when dealing with "almost empty auctions".
	\end{itemize}

\section*{Dutch Auction}
\label{sec:dutchAuction}

	\paragraph*{Main Functions}
	The file has two main methods:
	\begin{itemize}
		\item \emph{bid()}: This method simply allows a user to make a bid if everything respects the correctness parameters. 
		\item \emph{checkIfAuctionEnded()}: This method is only allowed to auction owner and allows to check if the auction has ended with no bidder.
	\end{itemize}
	In addition to these two the method provides some getter functions, in the form of \emph{Solidity View Methods}.
	
	\paragraph*{Events}
	The only  event that is generated by this auction is the one emitted when it ends. This is generated when either the owner discovers that no offers were given or when someone tries to bid but discovers that the limit time was reached.
	
	
	\paragraph*{Decrease Logic}
	The three implemented decrease logics are:
	\begin{itemize}
		\item \emph{Linear}: This contract simply provides the linear decrease logic, which goes linearly with the passing of time from \emph{startPrice} to \emph{reservePrice}.
		\item \emph{Exponential}: This contract provides the exponential decrease logic, which means that the first price drops are huge only to later decrease the price drops in order to reach the reservePrice
		\item \emph{Logarithmic}: This contract is the opposite of the exponential one, meaning that the first price drops are low, only to increase with time.
	\end{itemize}
	The $\ceil{\log_2x}$ function, used in order to implement both the logarithmic and the exponential decrease logic, was copied from a forum online. It uses inline assembly code and has a fixed cost of 757 \emph{wei}.
	
	\subsection*{Testing}
	In this section the \emph{Remix} deployment and the \emph{gas evaluation} will be addressed for the Dutch Auction. The evaluation will be done with the JavaScript VM.
	
		\paragraph*{Test Setup}: In order to test the Dutch Auction, the subsequent actions will be performed:
		\begin{enumerate}
			\item \emph{Activate compiler and deployer}: If on the new \emph{Remix} environment, the two components to activate are the \emph{Solidity compiler} and the \emph{Deploy and Run Transaction} components.
			\item \emph{Compile dutchAuction.sol}: This will also compile the file \emph{decreaseLogic.sol} because of the direct dependency. As a note, the compiler outputs warnings for the $\ceil{\log_2x}$ implementation provided in the file \emph{decreaseLogic.sol}, but they can be overlooked. The compiler version used in this examples is 0.5.1+commit.c8a2cb62 with enabled optimizations.
			\item \emph{Deploy a decrease logic}: In order to instantiate the auction contract, a decrease logic will be needed. The data following this section will be provided using a \emph{linear decrease logic} contract.
			\item \emph{Deploy the Dutch Auction}: At this point the contract can be deployed (passing as parameter, where the decrease logic is expected, the address of the previously deployed linear logic). For example, it is possible to use 1000 as start price, 100 as reserve price and 10 as duration.
			\item \emph{Make the grace period expire}: The grace period duration has been lowered to 2 blocks in order to ease testing. It is useful to consider the fact that remix virtually mines a block for each transaction. The first grace period block is burnt the moment the auction is created, so it is only necessary to call once one of the main methods (\emph{bid()} or \emph{checkIfAuctionEnded()}) in order to effectively end the grace period. As a note, calling any of the getters (view methods), do not burn a block number, so it is possible to always check the contract status.
			\item \emph{Try some losing bids}: Now is the time to try some failing bids, before making the winning one, with any account. At this point any non view method call burns a block (and decreases the current price by 100 in the example).
			\item \emph{Win the auction}: At this point, one can either make an account win the auction, or let it end with no winner.  
		\end{enumerate}
	
		\paragraph*{Gas Evaluation}
		The cost of the various points have been computed as: 
		\begin{itemize}
			\item The cost of deploying the two contracts (Decrease Logic and Dutch Auction) are respectively 88\,735 and 650\,446 wei. 
			\item The cost of skipping the grace period is 830 wei and will be neglected.
			\item The cost of every losing bid is 4687 and it is fixed (since they all fail at the same instruction). 
			\item The cost paid by the winner is fixed and it is 41\,619 wei. If instead the auction ends without a winner (the duration expires), then the cost is around 23\,651 wei.
		\end{itemize}
		Taking those values, then the final cost can be approximated as: $$totalCost \approx 88\,735 + 650\,446 + (4\,687 * \#losingBids) + lastEventCost $$
		Neglecting the losing bids, the auction owner pays around 740\,000 wei, while the winner pays around 40\,000 wei.
			

\section*{Vickrey Auction}
\label{sec:vickreyAuction}
	\paragraph{Main Functions}
	The main functions and modifiers provided by this file are:
	\begin{itemize}
		\item \emph{changeAuctionPhase(blockNumber)}: This is a modifier that checks the current time (current block number) with respect to the parameters passed when constructing the auction contract. This modifier is used before any of the following methods are called.
		\item \emph{bid(hash)}: This function takes a commitment as parameter and tries to submit it if all the parameters are respected (correct time range for making bids, paid deposit\dots).
		\item \emph{withdraw()}: This function, if all the parameters are respected, undoes the commitment of the function caller.  
		\item \emph{open(nonce)}: This function is both used to open the envelopes of the bids, and to refund losers immediately (before the owner calls finalize). The case of a non valid commitment (which means that the commitment hash and the hash computed with the received nonce do not coincide), is handled as a non valid bid, which means that the deposit fund is not refunded. This is the same treatment of an opening which reveals that the original payment was below the reserve price threshold.
		\item \emph{finalize()}: This function can only be called by the owner of the auction, and only when the auction state is \emph{ENDED}. This method simply refunds all the not yet refunded accounts.
		\item \emph{changeAuctionTime()}: This method simply calls the modifier specified to change the auction phase.
	\end{itemize}

	\paragraph*{Events}
	The events that are generated by this auction are:
	\begin{itemize}
		\item \emph{Time related events}: Those are simple events that follow the passing of time (phases). They are \emph{GraceTimeOver}, \emph{CommitmentOver}, \emph{WithdrawalOver} and \emph{AuctionEnded}. All those events carry some informations, like the number of current bidders (so the number of valid commitments that were submitted), and the duration of the next phase. As discussed in section \nameref{sec:common}, all those events are emitted in a \emph{lazy} way.
		\item \emph{Informative}: Those events (\emph{NewCommitment} and \emph{NewWithdrawal}) are emitted every time a new valid commitment is made or withdrawn.
	\end{itemize}
	
	\subsection*{Testing}
	In this section the \emph{Remix} deployment and the \emph{gas evaluation} will be addressed for the Vickrey Auction. \\ 

	
	

\end{document}          

